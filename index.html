<?php
// Código PHP para os arquivos .php
if (isset($_POST['id'])) {
    $db = new PDO("sqlite:base_dados.sqlite");
    $stmt = $db->prepare("DELETE FROM marcacoes WHERE id = :id");
    $stmt->bindParam(':id', $_POST['id']);
    $stmt->execute();
}
header("Location: ver_marcacoes.php");
exit;

// Código para guardar.php
ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);

if ($_SERVER['REQUEST_METHOD'] === 'POST' &&
    isset($_POST['nome'], $_POST['servico'], $_POST['data'], $_POST['hora'], $_POST['contacto'])) {

    $db = new PDO("sqlite:base_dados.sqlite");

    // Criar tabela se não existir
    $db->exec("CREATE TABLE IF NOT EXISTS marcacoes (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        nome TEXT,
        servico TEXT,
        data TEXT,
        hora TEXT,
        contacto TEXT
    )");

    $data = $_POST['data'];
    $hora = $_POST['hora'];

    // Verificar conflitos
    $verificar = $db->prepare("SELECT COUNT(*) FROM marcacoes WHERE data = :data AND hora = :hora");
    $verificar->bindParam(':data', $data);
    $verificar->bindParam(':hora', $hora);
    $verificar->execute();

    $existe = $verificar->fetchColumn();
    ?>

    <!DOCTYPE html>
    <html lang="pt">
    <head>
        <meta charset="UTF-8">
        <title>Resultado do Agendamento</title>
        <link rel="stylesheet" href="style.css">
    </head>
    <body>
        <div class="container">
            <h1>CaetanoBarberShop</h1>

            <?php if ($existe > 0): ?>
                <h2 style="color: #e74c3c;">Horário Ocupado</h2>
                <p>Já existe uma marcação para <strong><?= htmlspecialchars($data) ?> às <?= htmlspecialchars($hora) ?></strong>.</p>
                <a href="index.html"><button>Tentar Outro Horário</button></a>

            <?php else:
                $stmt = $db->prepare("INSERT INTO marcacoes (nome, servico, data, hora, contacto)
                                      VALUES (:nome, :servico, :data, :hora, :contacto)");
                $stmt->bindParam(':nome', $_POST['nome']);
                $stmt->bindParam(':servico', $_POST['servico']);
                $stmt->bindParam(':data', $data);
                $stmt->bindParam(':hora', $hora);
                $stmt->bindParam(':contacto', $_POST['contacto']);
                $stmt->execute();
            ?>
                <h2 style="color: #2ecc71;">Marcação Confirmada</h2>
                <p>Serviço: <strong><?= htmlspecialchars($_POST['servico']) ?></strong></p>
                <p>Data: <strong><?= htmlspecialchars($data) ?></strong> às <strong><?= htmlspecialchars($hora) ?></strong></p>
                <a href="index.html"><button>Nova Marcação</button></a>
                <a href="ver_marcacoes.php"><button>Ver Marcações</button></a>
            <?php endif; ?>
        </div>
    </body>
    </html>

<?php
} else {
    echo "<p style='color:red;'>Acesso inválido. Por favor submeta o formulário primeiro.</p>";
}
?>

<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>CaetanoBarberShop</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<?php
$horas_possiveis = ['10:00', '11:00', '12:00', '13:00', '16:00', '17:00', '18:00', '19:00'];
$horas_ocupadas = [];
$data_escolhida = isset($_GET['data']) ? $_GET['data'] : "";

if (!empty($data_escolhida)) {
    $db = new PDO("sqlite:base_dados.sqlite");
    $stmt = $db->prepare("SELECT hora FROM marcacoes WHERE data = :data");
    $stmt->bindParam(':data', $data_escolhida);
    $stmt->execute();
    $horas_ocupadas = $stmt->fetchAll(PDO::FETCH_COLUMN);
}
?>
    <div class="container">
        <h1>CaetanoBarberShop</h1>
        <h2>Agendar Corte</h2>
        <form action="guardar.php" method="post">
            
            <label>Nome:<br>
                <input type="text" name="nome" required>
            </label>
            <br><br>

            <label>Serviço:<br>
                <select name="servico" required>
                    <option value="Corte Masculino">Corte Masculino</option>
                    <option value="Barba com toalha quente">Barba com toalha quente</option>
                    <option value="Barba">Barba</option>
                    <option value="lavagem de cabelo">Lavagem de cabelo</option>
                </select>
            </label>
            <br><br>

            <label>Data:<br>
                <input type="date" name="data" required onchange="this.form.submit()" value="<?= htmlspecialchars($data_escolhida) ?>">
                <input type="hidden" name="reload" value="1">
            </label>
            <br><br>

            <label>Hora:<br>
                <select name="hora" required>
                <?php foreach ($horas_possiveis as $hora): ?>
                    <?php if (in_array($hora, $horas_ocupadas)): ?>
                        <option value="<?= $hora ?>" disabled style="text-decoration: line-through; color: #888;">
                            <?= $hora ?> (Ocupado)
                        </option>
                    <?php else: ?>
                        <option value="<?= $hora ?>"><?= $hora ?></option>
                    <?php endif; ?>
                <?php endforeach; ?>
                </select>
            </label>
            <br><br>

            <label>Contacto:<br>
                <input type="text" name="contacto" required>
            </label>
            <br><br>

            <button type="submit">Agendar</button>
        </form>
    </div>
</body>
</html>

<?php
// Código para ver_marcacoes.php
$db = new PDO("sqlite:base_dados.sqlite");
$dados = $db->query("SELECT * FROM marcacoes ORDER BY data, hora")->fetchAll(PDO::FETCH_ASSOC);
?>

<!DOCTYPE html>

<html lang="pt">
<head>
<meta charset="UTF-8">
<title>Marcações - Barbearia</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<div class="container">
<h1>CaetanoBarberShop</h1>
<h2>Lista de Marcações</h2>

<?php if (count($dados) > 0): ?>

<table>
<tr>
<th>Nome</th>
<th>Serviço</th>
<th>Data</th>
<th>Hora</th>
<th>Contacto</th>
<th>Ação</th>
</tr>
<?php foreach ($dados as $linha): ?>
<tr>
<td><?= htmlspecialchars($linha['nome']) ?></td>
<td><?= htmlspecialchars($linha['servico']) ?></td>
<td><?= htmlspecialchars($linha['data']) ?></td>
<td><?= htmlspecialchars($linha['hora']) ?></td>
<td><?= htmlspecialchars($linha['contacto']) ?></td>
<td>
    <form action="eliminar.php" method="post" onsubmit="return confirm('Tens a certeza que queres eliminar esta marcação?');">
        <input type="hidden" name="id" value="<?= $linha['id'] ?>">
        <button type="submit" style="background-color:#e74c3c;">Eliminar</button>
    </form>
</td>
</tr>
<?php endforeach; ?>
</table>
<?php else: ?>
<p>Sem marcações registadas.</p>
<?php endif; ?>
<br>
<a href="index.php"><button>Nova Marcação</button></a>
</div>
</body>
</html>
